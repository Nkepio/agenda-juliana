<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agenda - Studio Juliana Julia (Avan√ßada)</title>

<!-- FullCalendar CSS (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet"/>

<style>
:root{
  --primary:#d84315;
  --accent:#ff7043;
  --bg:#fef9f7;
  --card:#fff3e0;
  --ok:#00796b;
  --whatsapp:#25d366;
  --text:#333;
}
*{box-sizing:border-box}
body{
  font-family: "Segoe UI", Tahoma, Verdana, sans-serif;
  margin:0; background:var(--bg); color:var(--text);
}
header{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:14px 18px; border-bottom:1px solid rgba(0,0,0,0.06);
  background: linear-gradient(90deg, rgba(255,250,248,1) 0%, rgba(254,243,234,1) 100%);
}
header h1{ margin:0; font-size:18px; color:var(--primary); }
.header-right{ display:flex; gap:10px; align-items:center; }
.btn{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 3px 8px rgba(0,0,0,0.06); background:transparent; }
.btn.primary{ background:var(--primary); color:#fff; }
.btn.ghost{ background:transparent; border:1px solid rgba(0,0,0,0.06); }
.main{ display:flex; gap:18px; padding:18px; align-items:flex-start; }
#calendar { flex:1 1 700px; background:white; border-radius:12px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,0.06); min-width:300px; }

.side-panel{
  width:360px; max-width:36%; min-width:280px; background:var(--card);
  border-radius:12px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,0.06);
  display:flex; flex-direction:column; gap:12px; height: calc(100vh - 120px); overflow:auto;
}
.panel-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
.panel-header h2{ margin:0; font-size:16px; color:var(--primary); }
.small{ font-size:13px; color:#444; }
.controls-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

.search-group{ display:flex; gap:8px; }
.search-group input{ padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); }

.event-list{ display:flex; flex-direction:column; gap:10px; margin-top:6px; }
.event-card{ background:white; border-radius:10px; padding:10px; box-shadow:0 4px 8px rgba(0,0,0,0.04); display:flex; flex-direction:column; gap:8px; }
.event-row{ display:flex; justify-content:space-between; gap:8px; align-items:center; }
.event-meta{ font-weight:700; color:#222; }
.event-desc{ color:#555; font-size:13px; }

.chip{ padding:6px 8px; border-radius:8px; font-size:13px; font-weight:700; }
.chip.pendente{ background:#fff3e0; color:var(--primary); border:1px solid rgba(216,67,21,0.08); }
.chip.confirmado{ background:#e0f7fa; color:var(--ok); border:1px solid rgba(0,121,107,0.08); }

.event-actions{ display:flex; gap:6px; flex-wrap:wrap; }
.small-btn{ padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
.small-btn.whatsapp{ background:var(--whatsapp); color:#fff; }
.small-btn.delete{ background:#ff8a65; color:#fff; }
.small-btn.status{ background:#ffcc80; color:#333; }
.small-btn.edit{ background:#4fc3f7; color:#fff; }

form.add-form{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }
form label{ font-size:13px; color:#333; font-weight:600; }
form input, form textarea, form select{ padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); font-size:14px; }
.form-actions{ display:flex; gap:8px; }
.hint{ font-size:12px; color:#555; }

.login-panel{
  position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center;
}
.login-box{ background:white; padding:18px; border-radius:12px; width:320px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }

.footer-note{ padding:12px 18px; text-align:center; color:#666; font-size:13px; }

@media (max-width:1000px){
  .main{ flex-direction:column; padding:12px; }
  .side-panel{ width:100%; max-width:100%; min-width:unset; height:auto; order:2; }
  #calendar{ order:1; }
}
</style>
</head>
<body>

<header>
  <h1>Studio Juliana Julia ‚Äî Agenda</h1>
  <div class="header-right">
    <div id="userInfo" class="small"></div>
    <button id="todayBtn" class="btn ghost">Hoje</button>
    <button id="viewMonth" class="btn ghost">M√™s</button>
    <button id="viewWeek" class="btn ghost">Semana</button>
    <button id="viewDay" class="btn ghost">Dia</button>
     </div>
</header>

<div class="main">
  <div id="calendar"></div>

  <aside class="side-panel" id="sidePanel" aria-hidden="true">
    <div class="panel-header">
      <h2 id="panelTitle">Clique em um dia</h2>
      <div><span id="dayCount" class="small"></span></div>
    </div>

    <div class="controls-row">
      <div class="search-group" style="flex:1">
        <input type="search" id="searchName" placeholder="Pesquisar por nome..." />
      </div>
      <div>
        <input type="date" id="filterDate" title="Filtrar por data" />
      </div>
      <div>
        <button id="clearFilters" class="btn ghost">Limpar</button>
      </div>
    </div>

    <div class="hint">Hor√°rio de trabalho: <strong>07:00</strong> √†s <strong>21:00</strong>. Sem tempo m√≠nimo.</div>

    <div id="eventList" class="event-list"></div>

    <hr/>

    <div>
      <h3 style="margin:0 0 6px 0;">Adicionar / Editar agendamento</h3>

      <form id="addForm" class="add-form">
        <input type="hidden" id="editId" />
        <label>Nome</label>
        <input id="nome" type="text" required placeholder="Nome do cliente"/>

        <label>Servi√ßo</label>
        <input id="servico" type="text" placeholder="Ex: Manicure"/>

        <label>Contato</label>
	<div style="display:flex; gap:8px;">
  	 <input id="contato" type="text" required placeholder="Selecione ou digite..." style="flex:1;"/>
  	 <button type="button" id="pickContact" class="btn ghost">Agenda</button>
	</div>

        <label>Data</label>
        <input id="data" type="date" required />

        <label>Hora in√≠cio</label>
        <input id="horaInicio" type="time" required />

        <label>Hora fim</label>
        <input id="horaFim" type="time" required />

        <label>Status</label>
        <select id="status">
          <option value="pendente">Pendente</option>
          <option value="confirmado">Confirmado</option>
        </select>

        <label><input type="checkbox" id="autoWhats" /> Enviar WhatsApp automaticamente ao salvar</label>

        <div class="form-actions">
          <button type="submit" class="btn primary" style="flex:1;">Salvar</button>
          <button type="button" id="cancelEdit" class="btn">Limpar</button>
        </div>

        <div id="formMessage" class="hint"></div>
      </form>
    </div>

    <footer class="footer-note">Clique em um dia no calend√°rio para ver e gerenciar os hor√°rios.</footer>
  </aside>
</div>

<footer class="footer-note">Dados salvos localmente no navegador. FullCalendar carregado via CDN.</footer>

<!-- FullCalendar (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/pt-br.global.min.js"></script>

<script>
/* Agenda Avan√ßada - integra√ß√£o de todas as fun√ß√µes pedidas */

/* STORAGE KEY */
const STORAGE_KEY = 'agendaEventos_v2';

/* URL do Apps Script (sua planilha) */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzNCDf7y96_aCvomw8t6oz2OGZ6kQQrn1vwuXURvnABh7U00dTE5p8fpBHDHjV19ZJ4g/exec';

/* Helpers */
function saveStorage(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
function loadStorage(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ return []; } }
function uid(){ return Math.random().toString(36).slice(2,9); }
function toMinutes(t){ if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60 + m; }
function formatDateDot(dateStr){ const d=new Date(dateStr + 'T00:00:00'); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); return `${dd}.${mm}.${yyyy}`; }

/* Conflict check (same-day) */
function hasConflict(eventList, date, startMin, endMin, excludeId=null){
  return eventList.some(ev=>{
    if(ev.date !== date) return false;
    if(ev.id === excludeId) return false;
    const s = toMinutes(ev.start);
    const e = toMinutes(ev.end);
    return !(endMin <= s || startMin >= e);
  });
}

/* Convert to FullCalendar event */
function evToCalendarEvent(ev){
  return {
    id: ev.id,
    title: `${ev.name}${ev.service ? ' ‚Äî ' + ev.service : ''}`,
    start: ev.date + 'T' + ev.start,
    end: ev.date + 'T' + ev.end,
    allDay: false,
    extendedProps: {
      contact: ev.contact,
      status: ev.status,
      service: ev.service,
      date: ev.date,
      start: ev.start,
      end: ev.end,
      description: ev.description || ''
    }
  };
}

/* Envia para Google Sheets (Apps Script) */
async function sendToSheet(payload){
  try{
    // Usamos mode: 'no-cors' porque apps script muitas vezes n√£o retorna cabe√ßalhos CORS,
    // assim o envio √© feito mesmo que a resposta n√£o seja acess√≠vel no navegador.
    await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    console.log('Enviado para planilha (request feita).');
  }catch(e){
    console.error('Erro ao enviar para planilha:', e);
  }
}

/* Init Calendar */
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'pt-br',
    firstDay: 1,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: ''
    },
    height: 'auto',
    dayMaxEventRows: true,
    selectable: true,
    events: loadStorage().map(evToCalendarEvent),
    dateClick: function(info){ openPanelForDate(info.dateStr, calendar); },
    eventDidMount: function(info){
      const status = info.event.extendedProps.status;
      if(status === 'confirmado'){
        info.el.style.backgroundColor = '#e0f7fa';
        info.el.style.borderColor = '#00796b';
        info.el.style.color = '#004d40';
        info.el.style.borderRadius = '8px';
        info.el.style.padding = '4px';
      } else {
        info.el.style.backgroundColor = '#fff3e0';
        info.el.style.borderColor = '#d84315';
        info.el.style.color = '#5d2a11';
        info.el.style.borderRadius = '8px';
        info.el.style.padding = '4px';
      }
    }
  });

  calendar.render();
  window._fc = calendar;

  // Header buttons
  document.getElementById('todayBtn').addEventListener('click', ()=> calendar.today());
  document.getElementById('viewMonth').addEventListener('click', ()=> calendar.changeView('dayGridMonth'));
  document.getElementById('viewWeek').addEventListener('click', ()=> calendar.changeView('timeGridWeek'));
  document.getElementById('viewDay').addEventListener('click', ()=> calendar.changeView('timeGridDay'));
  // newBtn removed intentionally (n√£o usamos +Novo Agendamento)

  // search/filter handlers
  document.getElementById('searchName').addEventListener('input', ()=> {
    const date = document.getElementById('data').value || (window._fc ? window._fc.getDate().toISOString().slice(0,10) : null);
    if(date) openPanelForDate(date, calendar);
  });
  document.getElementById('filterDate').addEventListener('change', ()=> {
    const d = document.getElementById('filterDate').value;
    if(d) openPanelForDate(d, calendar);
  });
  document.getElementById('clearFilters').addEventListener('click', ()=> {
    document.getElementById('searchName').value='';
    document.getElementById('filterDate').value='';
    const curDate = document.getElementById('data').value || (window._fc ? window._fc.getDate().toISOString().slice(0,10) : null);
    if(curDate) openPanelForDate(curDate, calendar);
  });

  // form submit
  document.getElementById('addForm').addEventListener('submit', function(e){
    e.preventDefault();
    handleFormSubmit(calendar);
  });
  document.getElementById('cancelEdit').addEventListener('click', ()=> { clearForm(); document.getElementById('formMessage').textContent=''; });

  // If user is already logged, show info
  renderUserInfo();
});

/* Side panel open */
function openPanelForDate(dateStr, calendar){
  const panel = document.getElementById('sidePanel');
  panel.setAttribute('aria-hidden','false');
  document.getElementById('panelTitle').textContent = 'Agenda ‚Äî ' + formatDateDot(dateStr);

  // load events and apply search/filter
  const all = loadStorage();
  const search = (document.getElementById('searchName').value || '').toLowerCase();
  const filterDate = document.getElementById('filterDate').value;
  const dayEvents = all.filter(ev=> ev.date === dateStr)
                       .filter(ev => !search || ev.name.toLowerCase().includes(search))
                       .sort((a,b)=> a.start.localeCompare(b.start));

  renderEventList(dayEvents);
  document.getElementById('dayCount').textContent = dayEvents.length + ' compromissos';
  document.getElementById('data').value = dateStr;
  document.getElementById('editId').value = '';
  refreshCalendarEvents(calendar);
}

/* Render events in side panel */
function renderEventList(list){
  const container = document.getElementById('eventList');
  container.innerHTML = '';
  if(list.length === 0){
    const msg = document.createElement('div'); msg.className='hint'; msg.textContent='Nenhum compromisso para este dia.'; container.appendChild(msg); return;
  }
  list.forEach(ev=>{
    const card = document.createElement('div'); card.className='event-card';
    const row = document.createElement('div'); row.className='event-row';
    const meta = document.createElement('div'); meta.className='event-meta';
    meta.textContent = `${ev.name}${ev.service ? ' ‚Äî ' + ev.service : ''}`;
    row.appendChild(meta);
    const chip = document.createElement('div'); chip.className = 'chip ' + (ev.status === 'confirmado' ? 'confirmado' : 'pendente');
    chip.textContent = ev.status === 'confirmado' ? 'Confirmado' : 'Pendente';
    row.appendChild(chip);
    card.appendChild(row);

    const times = document.createElement('div'); times.className='event-desc';
    times.textContent = `${ev.start} ‚Äî ${ev.end} ¬∑ ${formatDateDot(ev.date)}`;
    card.appendChild(times);

    const actions = document.createElement('div'); actions.className='event-actions';

    const btnWhats = document.createElement('button'); btnWhats.className='small-btn whatsapp'; btnWhats.textContent='üì© WhatsApp';
    btnWhats.onclick = ()=> {
      const mensagem = `Studio Juliana Julia, confirma seu agendamento para o dia ${formatDateDot(ev.date)} √†s ${ev.start} - ${ev.end}. Nos vemos em breve. Obrigada.`;
      window.open(`https://wa.me/55${ev.contact}?text=${encodeURIComponent(mensagem)}`, '_blank');
    };
    actions.appendChild(btnWhats);

    const btnEdit = document.createElement('button'); btnEdit.className='small-btn edit'; btnEdit.textContent='‚úèÔ∏è Editar';
    btnEdit.onclick = ()=> populateFormForEdit(ev); actions.appendChild(btnEdit);

    const btnDelete = document.createElement('button'); btnDelete.className='small-btn delete'; btnDelete.textContent='üóëÔ∏è Apagar';
    btnDelete.onclick = ()=> { if(confirm('Apagar este agendamento?')){ deleteEvent(ev.id); openPanelForDate(ev.date, window._fc); } };
    actions.appendChild(btnDelete);

    const btnToggle = document.createElement('button'); btnToggle.className='small-btn status'; btnToggle.textContent = ev.status==='pendente'?'‚è≥ Confirmar':'‚úÖ Marcar Pendente';
    btnToggle.onclick = ()=> { toggleStatus(ev.id); openPanelForDate(ev.date, window._fc); };
    actions.appendChild(btnToggle);

    card.appendChild(actions);
    container.appendChild(card);
  });
}

/* Populate form for editing */
function populateFormForEdit(ev){
  document.getElementById('editId').value = ev.id;
  document.getElementById('nome').value = ev.name;
  document.getElementById('servico').value = ev.service || '';
  document.getElementById('contato').value = ev.contact;
  document.getElementById('data').value = ev.date;
  document.getElementById('horaInicio').value = ev.start;
  document.getElementById('horaFim').value = ev.end;
  document.getElementById('status').value = ev.status || 'pendente';
  document.getElementById('formMessage').textContent = 'Editando ‚Äî altere e salve.';
  scrollToForm();
}

/* Handle create / edit */
function handleFormSubmit(calendar){
  const id = document.getElementById('editId').value || uid();
  const name = document.getElementById('nome').value.trim();
  const service = document.getElementById('servico').value.trim();
  const contact = document.getElementById('contato').value.trim();
  const date = document.getElementById('data').value;
  const start = document.getElementById('horaInicio').value;
  const end = document.getElementById('horaFim').value;
  const status = document.getElementById('status').value;
  const autoWhats = document.getElementById('autoWhats').checked;

  if(!name || !contact || !date || !start || !end){
    document.getElementById('formMessage').textContent = 'Preencha todos os campos obrigat√≥rios.';
    return;
  }
  if(start < '07:00' || end > '21:00' || start >= end){
    document.getElementById('formMessage').textContent = 'Hor√°rios devem estar entre 07:00 e 21:00 e in√≠cio < fim.';
    return;
  }

  const startMin = toMinutes(start);
  const endMin = toMinutes(end);
  const events = loadStorage();
  if(hasConflict(events, date, startMin, endMin, id)){
    document.getElementById('formMessage').textContent = 'Hor√°rio indispon√≠vel ‚Äî existe conflito.';
    return;
  }

  const obj = { id, name, service, contact, date, start, end, status };

  let all = loadStorage();
  const existsIdx = all.findIndex(x=> x.id === id);
  if(existsIdx >= 0){
    all[existsIdx] = obj;
  } else {
    all.push(obj);
  }
  all.sort((a,b)=> a.date.localeCompare(b.date) || a.start.localeCompare(b.start));
  saveStorage(all);

  // refresh calendar and panel
  refreshCalendarEvents(calendar);
  openPanelForDate(date, calendar);

  // optional: open WhatsApp to notify immediately
  if(autoWhats){
    const mensagem = `Studio Juliana Julia, confirma seu agendamento para o dia ${formatDateDot(date)} √†s ${start} - ${end}. Nos vemos em breve. Obrigada.`;
    window.open(`https://wa.me/55${contact}?text=${encodeURIComponent(mensagem)}`, '_blank');
  }

  // Envia para planilha (nome | contato | data | horaInicio | horaFim | descricao)
  sendToSheet({
    nome: name,
    contato: contact,
    data: date,
    horaInicio: start,
    horaFim: end,
    descricao: service || ''
  });

  document.getElementById('formMessage').textContent = 'Salvo com sucesso!';
  setTimeout(()=>{ document.getElementById('formMessage').textContent = ''; }, 2000);
  clearForm();
}

/* delete, toggle status, clear form */
function deleteEvent(id){
  let all = loadStorage();
  all = all.filter(e=> e.id !== id);
  saveStorage(all);
  refreshCalendarEvents(window._fc);
}
function toggleStatus(id){
  const all = loadStorage();
  const idx = all.findIndex(e=>e.id===id);
  if(idx>=0){ all[idx].status = all[idx].status==='pendente'?'confirmado':'pendente'; saveStorage(all); refreshCalendarEvents(window._fc); }
}
function clearForm(){
  document.getElementById('editId').value='';
  document.getElementById('nome').value='';
  document.getElementById('servico').value='';
  document.getElementById('contato').value='';
  document.getElementById('horaInicio').value='';
  document.getElementById('horaFim').value='';
  document.getElementById('status').value='pendente';
  document.getElementById('autoWhats').checked = false;
  document.getElementById('formMessage').textContent='';
}

/* calendar refresh */
function refreshCalendarEvents(calendar){
  const all = loadStorage();
  calendar.removeAllEvents();
  all.forEach(ev=> calendar.addEvent(evToCalendarEvent(ev)));
}

/* scrolling helper */
function scrollToForm(){ const el=document.getElementById('addForm'); if(el) setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'center'}),150); }

/* LOGIN (sem senha) */
function showLogin(){
  // build modal
  const existing = document.getElementById('loginModal');
  if(existing) return;
  const modal = document.createElement('div'); modal.id='loginModal'; modal.className='login-panel';
  modal.innerHTML = `
    <div class="login-box">
      <h3>Entrar (sem senha)</h3>
      <label>Seu nome</label>
      <input id="loginName" type="text" style="width:100%; padding:8px; margin:8px 0; border-radius:8px; border:1px solid #eee"/>
      <label>Seu telefone (apenas n√∫meros, ex: 5511999999999)</label>
      <input id="loginPhone" type="text" style="width:100%; padding:8px; margin:8px 0; border-radius:8px; border:1px solid #eee"/>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="loginSave" class="btn primary" style="flex:1;">Entrar</button>
        <button id="loginCancel" class="btn" style="flex:1;">Cancelar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  document.getElementById('loginCancel').onclick = ()=> { modal.remove(); };
  document.getElementById('loginSave').onclick = ()=> {
    const name = document.getElementById('loginName').value.trim();
    const phone = document.getElementById('loginPhone').value.trim();
    if(!name || !phone){ alert('Preencha nome e telefone.'); return; }
    localStorage.setItem('agendaUser', JSON.stringify({name, phone}));
    modal.remove();
    renderUserInfo();
  };
}
function renderUserInfo(){
  const userInfoEl = document.getElementById('userInfo');
  const u = JSON.parse(localStorage.getItem('agendaUser') || 'null');
  if(u){
    userInfoEl.textContent = `Ol√°, ${u.name}`;
    // loginBtn n√£o existe no layout atual mas mantive a l√≥gica caso insira depois
    const lb = document.getElementById('loginBtn');
    if(lb){ lb.textContent = 'Sair'; lb.onclick = ()=> { if(confirm('Sair da sess√£o?')){ localStorage.removeItem('agendaUser'); renderUserInfo(); } }; }
  } else {
    userInfoEl.textContent = '';
    const lb = document.getElementById('loginBtn');
    if(lb){ lb.textContent = 'Entrar'; lb.onclick = showLogin; }
  }
}

/* init utilities (none) */
(function initUI(){
  // nothing for now
})();

// üì± Selecionar n√∫mero da agenda do celular (Contact Picker API)
const pickContactBtn = document.getElementById('pickContact');
if(pickContactBtn){
  pickContactBtn.addEventListener('click', async ()=>{
    if(!('contacts' in navigator)){
      alert("Seu navegador n√£o suporta acesso √† agenda.");
      return;
    }

    try{
      const props = ['tel', 'name'];
      const opts = { multiple: false };
      const contacts = await navigator.contacts.select(props, opts);

      if(contacts.length > 0){
        const c = contacts[0];
        const tel = (c.tel && c.tel[0]) ? c.tel[0].replace(/\D/g, '') : '';
        document.getElementById('contato').value = tel;
        if(c.name && c.name[0] && !document.getElementById('nome').value){
          document.getElementById('nome').value = c.name[0];
        }
      }
    }catch(e){
      console.log("Permiss√£o negada ou erro:", e);
    }
  });
}

</script>
</body>
</html>
